<template>
  <div
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-[100dvh] relative"
  >
    <!-- 訊息提示框 -->
    <MessageBox :message="errorMessage" />

    <div class="container mx-auto px-4 py-4">
      <!-- 標題區域（會根據影片載入狀態調整，輸入框有焦點時隱藏） -->
      <Transition name="header" mode="out-in">
        <div v-if="!hasVideoLoaded && !isInputFocused" class="text-center mb-8">
          <h1
            class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-2"
          >
            TubeTuner
          </h1>
          <p class="text-xl text-gray-300">YouTube 影片速度控制器</p>
          <div
            class="w-24 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mx-auto mt-4"
          ></div>
        </div>
        <div v-else-if="!isInputFocused" class="flex items-center justify-between mb-4">
          <h1
            class="text-2xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent"
          >
            TubeTuner
          </h1>
          <!-- 統一控制按鈕 -->
          <button
            @click="toggleControlPanel"
            class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg hover:shadow-purple-500/30 transition-all duration-75 flex items-center gap-2 active:scale-95"
            title="打開控制面板"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span v-if="!aiConfig.canUseAI" class="w-2 h-2 bg-orange-400 rounded-full"></span>
          </button>
        </div>
      </Transition>

      <div class="max-w-7xl mx-auto flex-1">
        <!-- YouTube 播放器區域（全寬） -->
        <div :class="hasVideoLoaded ? 'w-full sticky top-0' : 'max-w-4xl mx-auto'">
          <YouTubePlayer
            :player="youtubePlayer"
            @player-ready="handlePlayerReady"
            @video-loaded="handleVideoLoaded"
            @error="showError"
          />
        </div>

        <!-- AI 聊天記錄區域 -->
        <div v-if="hasVideoLoaded" class="mt-6 mb-32">
          <ChatHistory />
        </div>
      </div>
    </div>

    <!-- 浮動控制面板 -->
    <FloatingControlPanel
      ref="controlPanelRef"
      v-if="hasVideoLoaded"
      :player="youtubePlayer"
      @speed-changed="handleSpeedChanged"
      @seeked="handleSeeked"
      @play-state-changed="handlePlayStateChanged"
      @error="showError"
      @video-loaded="handleVideoLoaded"
      @input-focused="handleInputFocused"
      @input-blurred="handleInputBlurred"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { useYouTubePlayer } from '@/composables/useYouTubePlayer'
import { useAIConfigStore } from '@/stores/aiConfig'
import YouTubePlayer from '@/components/YouTubePlayer.vue'
import FloatingControlPanel from '@/components/FloatingControlPanel.vue'
import MessageBox from '@/components/MessageBox.vue'
import ChatHistory from '@/components/ChatHistory.vue'

const youtubePlayer = useYouTubePlayer()
const aiConfig = useAIConfigStore()
const errorMessage = ref('')
const hasVideoLoaded = ref(false)
const controlPanelRef = ref()
const isInputFocused = ref(false)


onMounted(async () => {
  await youtubePlayer.initPlayer('youtube-player')
  aiConfig.loadFromStorage()
})

// 監聽影片載入狀態
watch(() => youtubePlayer.currentVideoId.value, (videoId) => {
  if (videoId) {
    hasVideoLoaded.value = true
    console.log('自動載入的影片 ID:', videoId)
  }
})

const handlePlayerReady = () => {
  console.log('播放器已準備好')
}

const handleVideoLoaded = (videoId: string) => {
  console.log('影片已載入:', videoId)
  hasVideoLoaded.value = true
}

const handleSpeedChanged = (speed: number) => {
  console.log('播放速度已變更:', speed)
}

const handleSeeked = (seconds: number) => {
  console.log('已跳轉:', seconds, '秒')
}

const handlePlayStateChanged = (isPlaying: boolean) => {
  console.log('播放狀態已變更:', isPlaying ? '播放中' : '已暫停')
}

const showError = (message: string) => {
  errorMessage.value = message
  // 觸發 MessageBox 的 watch
  setTimeout(() => {
    errorMessage.value = ''
  }, 100)
  setTimeout(() => {
    errorMessage.value = message
  }, 150)
}

// 控制面板切換函數
const toggleControlPanel = () => {
  if (controlPanelRef.value?.expand) {
    controlPanelRef.value.expand()
  }
}

// 輸入框焦點事件處理
const handleInputFocused = () => {
  isInputFocused.value = true
}

const handleInputBlurred = () => {
  isInputFocused.value = false
}
</script>

<style scoped>
/* 標題過渡動畫 */
.header-enter-active,
.header-leave-active {
  transition: all 0.3s ease;
}

.header-enter-from {
  opacity: 0;
  transform: translateY(-20px);
}

.header-leave-to {
  opacity: 0;
  transform: translateY(20px);
}

/* 輸入框彈出動畫 */
.input-popup-enter-active {
  transition: none;
}

.input-popup-leave-active {
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

.input-popup-enter-from,
.input-popup-leave-to {
  opacity: 0;
  transform: translateY(-5px) scale(0.98);
}
</style>
