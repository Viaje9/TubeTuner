<div class="space-y-4" [class.hidden]="showChat()">
  <!-- 標題區域 -->
  <div *ngIf="!hasVideoLoaded; else loadedHeader" class="text-center mb-2 relative">
    <div class="absolute top-0 right-0 flex items-center gap-2">
      <a
        routerLink="/menu"
        class="bg-gray-800/70 hover:bg-gray-700 text-white p-2 rounded-lg inline-flex items-center justify-center"
        title="選單"
      >
        <app-menu-icon [cls]="'w-5 h-5'"></app-menu-icon>
      </a>
      <button
        class="bg-gray-800/70 hover:bg-gray-700 text-white p-2 rounded-lg inline-flex items-center justify-center"
        (click)="openSettings()"
        title="播放設定"
      >
        <app-settings-icon [cls]="'w-5 h-5'"></app-settings-icon>
      </button>
    </div>
    <h1
      class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-2"
    >
      TubeTuner
    </h1>
    <p class="text-lg text-gray-300">本機影片播放器</p>
    <div
      class="w-24 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mx-auto mt-4"
    ></div>
  </div>
  <ng-template #loadedHeader>
    <div class="flex items-center justify-between">
      <div class="flex flex-col">
        <h2
          class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent"
        >
          TubeTuner
        </h2>
        <div class="text-sm text-gray-300 mt-1" *ngIf="hasVideoLoaded">
          播放時間: {{ formatTime(currentTime()) }}
        </div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button
          (click)="openChatWithSelected()"
          class="bg-gray-800/70 hover:bg-gray-700 text-white p-2 rounded-lg inline-flex items-center justify-center"
          title="AI 對話（帶入收藏）"
        >
          <app-star-solid-icon [cls]="'w-5 h-5'"></app-star-solid-icon>
        </button>
        <button
          class="bg-gray-800/70 hover:bg-gray-700 text-white p-2 rounded-lg inline-flex items-center justify-center"
          (click)="openChat()"
          title="開啟 AI 對話"
        >
          <app-chat-bubble-icon [cls]="'w-5 h-5'"></app-chat-bubble-icon>
        </button>
        <button
          class="bg-gray-800/70 hover:bg-gray-700 text-white p-2 rounded-lg inline-flex items-center justify-center"
          (click)="openSettings()"
          title="AI 設定"
        >
          <app-settings-icon [cls]="'w-5 h-5'"></app-settings-icon>
        </button>
      </div>
    </div>
  </ng-template>

  <!-- 上傳區域 -->
  <div class="space-y-6">
    <!-- 隱藏的字幕檔案輸入（提供給左上角按鈕使用） -->
    <input
      #subtitleFileInput
      type="file"
      accept=".srt,.json"
      class="hidden"
      (change)="onSubtitleSelected($event)"
    />
    <!-- 影片拖放區域（未載入影片時顯示） -->
    <div class="space-y-4" *ngIf="!hasVideoLoaded">
      <h2 class="text-lg font-semibold text-white">上傳本機影片</h2>
      <div
        (drop)="handleDrop($event)"
        (dragover)="handleDragOver($event)"
        (dragenter)="handleDragEnter($event)"
        (dragleave)="handleDragLeave($event)"
        (click)="triggerFileInput()"
        [class]="
          'border-2 border-dashed rounded-2xl p-8 transition-all duration-200 cursor-pointer ' +
          (isDragging()
            ? 'border-blue-500 bg-blue-500/10'
            : 'border-gray-600 bg-gray-700/30 hover:border-gray-500 hover:bg-gray-700/50')
        "
      >
        <div class="text-center">
          <app-cloud-upload-icon
            [cls]="'w-12 h-12 mx-auto mb-4 ' + (isDragging() ? 'text-blue-500' : 'text-gray-400')"
          ></app-cloud-upload-icon>
          <h3 class="text-lg font-medium text-white mb-2">
            {{ isDragging() ? '放下檔案來上傳' : '拖放或點擊上傳影片檔案' }}
          </h3>
          <p class="text-gray-400 text-sm">支援格式：MP4, WebM, OGG</p>
        </div>
      </div>
      <input
        #videoFileInput
        type="file"
        accept="video/*"
        class="hidden"
        (change)="onFile($event)"
      />
    </div>

    <!-- 原字幕上傳區塊移除，改用影片左上角的小按鈕觸發 -->
  </div>

  <!-- 內容區：影片 + 字幕面板 -->
  <div
    [class]="
      'grid gap-4 ' +
      (hasVideoLoaded && hasSubtitles && showSubtitlePanel() ? 'lg:grid-cols-3' : '')
    "
  >
    <div [class]="hasVideoLoaded && hasSubtitles && showSubtitlePanel() ? 'lg:col-span-2' : ''">
      <div class="relative">
        <!-- 左上角字幕上傳按鈕（有影片時顯示） -->
        <button
          *ngIf="hasVideoLoaded"
          (click)="triggerSubtitleInput()"
          class="absolute top-2 left-2 z-20 bg-gray-800/80 hover:bg-gray-700 text-white border border-gray-600 rounded-md px-2 py-1 text-xs flex items-center gap-1"
        >
          <app-document-icon [cls]="'w-4 h-4'"></app-document-icon>
          上傳字幕
        </button>
        <video
          #video
          *ngIf="src() as url"
          class="w-full max-h-[60vh] bg-black"
          [src]="url"
          playsinline
          (loadedmetadata)="onLoadedMetadata()"
          (timeupdate)="onTimeUpdate()"
          (play)="onPlay()"
          (pause)="onPause()"
        ></video>

        <!-- 字幕浮層元件已移除，僅保留側欄清單顯示 -->
      </div>

      <!-- 調速移至設定對話框 -->
    </div>

    <div *ngIf="hasVideoLoaded && hasSubtitles && showSubtitlePanel()" class="lg:col-span-1">
      <app-subtitle-scroll
        [subtitles]="subtitles()"
        [currentTime]="currentTime()"
        [isPlaying]="isPlaying()"
        [videoId]="videoId()"
        (seekTo)="seekTo($event)"
      />
    </div>
  </div>

  <!-- 底部固定播放控制條 -->
  <div
    *ngIf="hasVideoLoaded && !showChat()"
    class="fixed inset-x-0 bottom-0 z-40 bg-gradient-to-t from-gray-900 via-gray-800 to-gray-800 border-t border-gray-700/50"
  >
    <div class="flex items-center px-6 py-4 pb-10">
      <!-- 左側：快速後退 -->
      <div class="flex-1 flex justify-start">
        <button
          (click)="handleRewind()"
          [class]="
            'flex items-center justify-center w-14 h-14 rounded-full transition-all duration-200 shadow-lg bg-gradient-to-br from-orange-500 to-red-600 text-white active:scale-95 ' +
            (rewindClicked() ? 'animate-pulse scale-125 ring-2 ring-orange-300' : '')
          "
          [title]="'後退 ' + prefs.seekStep() + ' 秒'"
        >
          <div class="flex flex-col items-center">
            <app-rewind-icon [cls]="'w-4 h-4'"></app-rewind-icon>
            <span class="text-xs font-bold leading-tight">-{{ prefs.seekStep() }}</span>
          </div>
        </button>
      </div>

      <!-- 中央：播放/暫停 -->
      <div class="flex justify-center">
        <button
          (click)="handleTogglePlayPause()"
          [disabled]="!isReady()"
          class="flex items-center justify-center w-16 h-16 rounded-full transition-all duration-300 shadow-lg bg-gradient-to-br from-blue-500 to-purple-600 text-white active:scale-95 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed"
          [title]="isPlaying() ? '暫停' : '播放'"
        >
          <app-play-icon *ngIf="!isPlaying()" [cls]="'w-6 h-6 ml-0.5'"></app-play-icon>
          <app-pause-icon *ngIf="isPlaying()" [cls]="'w-5 h-5'"></app-pause-icon>
        </button>
      </div>

      <!-- 右側：快速前進 -->
      <div class="flex-1 flex justify-end">
        <button
          (click)="handleForward()"
          [class]="
            'flex items-center justify-center w-14 h-14 rounded-full transition-all duration-200 shadow-lg bg-gradient-to-br from-green-500 to-teal-600 text-white active:scale-95 ' +
            (forwardClicked() ? 'animate-pulse scale-125 ring-2 ring-green-300' : '')
          "
          [title]="'前進 ' + prefs.seekStep() + ' 秒'"
        >
          <div class="flex flex-col items-center">
            <app-forward-icon [cls]="'w-4 h-4'"></app-forward-icon>
            <span class="text-xs font-bold leading-tight">+{{ prefs.seekStep() }}</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI 對話視圖（同頁顯示） -->
<div *ngIf="showChat()" class="min-h-[100dvh] flex flex-col">
  <div class="flex-1 overflow-hidden">
    <app-ai-chat [onBack]="closeChat.bind(this)" />
  </div>
</div>
